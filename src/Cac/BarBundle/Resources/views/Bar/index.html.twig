{% extends "::base.html.twig" %}

{% block title %}CacBarBundle:Bar:index{% endblock %}

{% block body %}

<div class="topListBar col-xs-12 col-sm-12 col-md-12 noPadding">
			<!-- <img src="{{asset('img/accueil.png')}}" alt="">
			<img src="{{asset('img/pershing.png')}}" alt="">
			<img src="{{asset('img/fondFicheBar.png')}}" alt=""> -->



			{% set exit = true %}
			{% for bar in bars if exit %}
				{# if highlight[0] is defined %}
					<img src="{{ asset('uploads/bar/'~highlight[0].bar.path) }}" alt="">
					<div class="infoTopListBar">
						<h2>{{highlight[0].bar.name}}</h2>
						<p class="adresseTopListBar">{{ highlight[0].bar.zipcode }} {{ highlight[0].bar.town }}</p>
						<div class="infoBarTopListBar col-xs-12 col-sm-12 col-md-12">
							<p class="col-xs-4 col-sm-4 col-md-4 noPadding">-30%</p>
							<p class="col-xs-4 col-sm-4 col-md-4 noPadding"><img src="{{asset('img/pictoHappyHours.png')}}" alt=""></p>
							<div class="noteBarTopListBar col-xs-4 col-sm-4 col-md-4 noPadding">
								<p>8,7/10</p>
								<p class="avisBarTopListBar">30 avis</p>
							</div>
							<div class="clear"></div>
						</div>
						<p class="enSavoirPlusTopListBar"><a href="{{ path('bar_show', { id : highlight[0].bar.id }) }}">En savoir plus</a></p>	
					</div>
				{% else%}
					<img src="{{ asset('uploads/bar/'~bar.path) }}" alt="">
					<div class="infoTopListBar">
						<h2>{bar.name}}</h2>
						<p class="adresseTopListBar">{{ bar.zipcode }} {{ bar.town }}</p>
						<div class="infoBarTopListBar col-xs-12 col-sm-12 col-md-12">
							{% if bar.promo  %}
								<p class="col-xs-4 col-sm-4 col-md-4 noPadding">-{{ bar.promo }}%</p>
							{% endif %}
							{% if bar.happy  %}
								<p class="col-xs-4 col-sm-4 col-md-4 noPadding"><img src="{{asset('img/pictoHappyHours.png')}}" alt=""></p>
							{% endif %}
							{% if bar.nbAvis  %}
								<div class="noteBarTopListBar col-xs-4 col-sm-4 col-md-4 noPadding">
									<p>8,7/10</p>
									<p class="avisBarTopListBar">30 avis</p>
								</div>
							{% endif %}
							<div class="clear"></div>
						</div>
						<p class="enSavoirPlusTopListBar"><a href="{{ path('bar_show', { id : bar.id }) }}">En savoir plus</a></p>
					</div>
				{% endif#}

				
				{% set exit = false %}
			{% endfor%}


</div>
<div class="headerList col-xs-12 col-sm-12 col-md-12 noPadding">
	<div class="menuHeaderList col-xs-6 col-sm-3 col-md-3 noPadding">
		<p class="best">Les bests</p>
	</div>
	<div class="menuHeaderList col-xs-6 col-sm-3 col-md-3 noPadding">
		<p class="hottest">Les nouveaux</p>
	</div>
	<div class="menuHeaderList col-xs-6 col-sm-3 col-md-3 noPadding">
		<p class="small-price">Les petits prix</p>
	</div>
	<div class="center col-xs-6 col-sm-3 col-md-3 noPadding">
		<div id="recherche" class="col-xs-10 col-sm-10 col-md-10 noPadding">
			<input type="text" name="recherche" class="col-xs-9 col-sm-9 col-md-10 noPadding" placeholder="Tapez votre recherche" id="barsSearchInput" data-target="{{ path('bars_search') }}"></input>
		</div>
	</div>
</div>
<div class="barList col-xs-12 col-sm-12 col-md-12 noPadding hidden" id="barsSearchResults">
</div>
<div class="barList col-xs-12 col-sm-12 col-md-12 noPadding" id="noSearchList">
{% set nbLoops = 0 %}
{% for bar in bars %}
	<a href="{{ path('bar_show', { id : bar.id }) }}">
		<div class="barInList col-xs-12 col-sm-6 col-md-3 noPadding">
			<div class="contentImageBar" style="background-image:url({{ asset('uploads/bar/'~bar.path) }})">
				<div class="shadowbarInList col-xs-12 col-sm-12 col-md-12">
					<div class="col-xs-6 col-sm-6 col-md-5 noPadding">
						<h3 id="firstWord{{ bar.id }}">{{ bar.name }}</h3>
					</div>
					<div class="col-xs-2 col-sm-2 col-md-2 noPadding">
					{% if bar.promo  %}
						<p class="shadowPromotion hoverShadow">-{{ bar.promo }}%</p>
					{% endif %}
					</div>
					<div class="col-xs-2 col-sm-2 col-md-2 noPadding">
					{% if bar.happy  %}
						<div class="imageHappyHours hoverShadow">
							<img src="{{asset('img/pictoHappyHours.png')}}" alt="">
						</div>
					{% endif %}
					</div>
					<div class="col-xs-2 col-sm-2 col-md-3 noPadding">
					{% if bar.nbAvis  %}
						<p class="shadowNote">{{ bar.note }}/10</p>
						<p class="shadowNbAvis hoverShadow">{{ bar.nbAvis }} avis</p>
					{% endif %}
					</div>
					<div class="shadowAdresse col-xs-12 col-sm-12 col-md-12 noPadding hoverShadow">
						<p>{{ bar.adress }}, {{ bar.zipcode }} {{ bar.town }}</p>
					</div>
				</div>
			</div>
		</div>
	</a>
	{% if loop.index %8 == 0 %}


	{% for bar in highlight|slice(0, 2) if bar is not null %}
		plop
	{% endfor %}

		{% if nbLoops == 0 %}
			{# if highlight[0] is defined %}

			{{ld(highlight)}}
			{% set nbLoops = 1 %}
				<a href="{{ path('bar_show', { id : highlight[0].bar.id }) }}">
					<div class="HightlightLeft col-xs-12 col-sm-6 col-md-6 noPadding">
						<div class="barInListHighlight barInList col-xs-12 col-sm-12 col-md-12 noPadding">
							<div class="contentImageBar" style="background-image:url({{ asset('uploads/bar/'~highlight[0].bar.path) }})">
								<div class="shadowbarInList col-xs-12 col-sm-12 col-md-12">
									<div class="col-xs-10 col-sm-10 col-md-10 noPadding">
										<h3 id="firstWord{{ highlight[0].bar.id }}">{{ highlight[0].bar.name }}</h3>
									</div>
									
									<div class="col-xs-2 col-sm-2 col-md-2 noPadding">
										{% if bar.note !=0 %}
											<p class="shadowNote">{{ bar.note }}/10</p>
										{% endif %}
										{% if bar.nbAvis !=0 %}
											<p class="shadowNbAvis hoverShadow">{{ bar.nbAvis }} avis</p>
										{% endif %}
									</div>
									<div class="shadowAdresse col-xs-12 col-sm-12 col-md-12 noPadding">
										<div class="col-xs-2 col-sm-2 col-md-2 noPadding">
											<p class="shadowPromotion">-{{ bar.promo }}%</p>
										</div>
										<div class="col-xs-1 col-sm-1 col-md-1 noPadding">
											<div class="imageHappyHours">
												<img src="{{asset('img/pictoHappyHours.png')}}" alt="">
											</div>
										</div>
										<div class="col-xs-2 col-sm-2 col-md-2 noPadding">
											
												<p class="priceBar">€€€€€</p>
											
										</div>
										<div class="col-xs-3 col-sm-3 col-md-3 noPadding">
											<p class="allureBar">Chic et élégant</p>
										</div>
										<div class="col-xs-4 col-sm-4 col-md-4 noPadding">
											<p class="tagBar">Les bests, les cosy</p>
										</div>
									</div>
									<div class="shadowAdresse col-xs-12 col-sm-12 col-md-12 noPadding hoverShadow">
										<p class="adresseBar">{{ highlight[0].bar.adress }}, {{ highlight[0].bar.zipcode }} {{ highlight[0].bar.town }}</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</a>
			{% endif %}
			{% if highlight[1] is defined %}
				<a href="{{ path('bar_show', { id : highlight[1].bar.id }) }}">
					<div class="HightlightRight col-xs-12 col-sm-6 col-md-6 noPadding">
						<div class="barInListHighlight barInList col-xs-12 col-sm-12 col-md-12 noPadding">
							<div class="contentImageBar" style="background-image:url({{ asset('uploads/bar/'~highlight[1].bar.path) }})">
								<div class="shadowbarInList col-xs-12 col-sm-12 col-md-12">
									<div class="col-xs-10 col-sm-10 col-md-10 noPadding">
										<h3 id="firstWord{{ highlight[1].bar.id }}">{{ highlight[1].bar.name }}</h3>
									</div>
									
									<div class="col-xs-2 col-sm-2 col-md-2 noPadding">
										{% if bar.note !=0 %}
											<p class="shadowNote">{{ bar.note }}/10</p>
										{% endif %}
										{% if bar.nbAvis !=0 %}
											<p class="shadowNbAvis hoverShadow">{{ bar.nbAvis }} avis</p>
										{% endif %}
									</div>
									<div class="shadowAdresse col-xs-12 col-sm-12 col-md-12 noPadding">
										<div class="col-xs-2 col-sm-2 col-md-2 noPadding">
											<p class="shadowPromotion">-{{ bar.promo }}%</p>
										</div>
										<div class="col-xs-1 col-sm-1 col-md-1 noPadding">
											<div class="imageHappyHours">
												<img src="{{asset('img/pictoHappyHours.png')}}" alt="">
											</div>
										</div>
										<div class="col-xs-3 col-sm-3 col-md-3 noPadding">
											<p class="allureBar">Chic et élégant</p>
										</div>
										<div class="col-xs-4 col-sm-4 col-md-4 noPadding">
											<p class="tagBar">Les bests, les cosy</p>
										</div>
									</div>
									<div class="shadowAdresse col-xs-12 col-sm-12 col-md-12 noPadding hoverShadow">
										<p class="adresseBar">{{ highlight[1].bar.adress }}, {{ highlight[1].bar.zipcode }} {{ highlight[1].bar.town }}</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</a>
			{% endif #}
		{% endif %}
	{% endif %}

{% endfor %}

</div>

<div class="clear"></div>
<div class="navigation">
    {{ knp_pagination_render(bars) }}
</div>
{% endblock %}
{% block javascripts %}
	{{ parent() }}
    <script src="{{ asset('js/sort-affichage.js') }}" type="text/javascript" /></script>
    <script>
	var xhr = null,
        globalTimeout = null,
        $resultBody = $("#barsSearchResults"),
		$searchInput = $("#barsSearchInput"),
		$noSearchList = $('#noSearchList'),
		searchPath = $searchInput.attr('data-target');

	$searchInput.keyup( function(event){

        if (globalTimeout != null)
            clearTimeout(globalTimeout);

        globalTimeout = setTimeout(function() {  
            var search = $searchInput.val();

            search = search.replace(/<\/?[^>]+>/gi, '');
            globalTimeout = null;

            if (search.length >= 2) {
                if (xhr != null) //abort last request if not over
                    xhr.abort();

                xhr = $.ajax({
                    url: searchPath,
                    dataType: "json",
                    method: "post",
                    data: {search: search},
                    success: function( data ) {
                        var strToAppend = '';

                        $.each(data, function (key, val) {
                        	strToAppend += '<a href="' + Routing.generate('bar_show', { id: val.id }) + '">'
											+ '<div class="barInList col-xs-12 col-sm-6 col-md-3 noPadding">'
											+ '	<div class="contentImageBar" style="background-image:url(\'/web/uploads/bar/' + val.path + '\')">'
													
											+ '			<div class="shadowbarInList col-xs-12 col-sm-12 col-md-12">'
											+ '				<div class="col-xs-6 col-sm-6 col-md-5 noPadding">'
											+ '					<h3 id="firstWord' + val.id + '">' + val.name + '</h3>'
											+ '				</div>'
											+ '				<div class="col-xs-2 col-sm-2 col-md-2 noPadding">';
							if(val.promotions[0].options[0].value != '') {
								strToAppend += '<p class="shadowPromotion hoverShadow">-' + val.promotions[0].options[0].value + '%</p>';
							}
							strToAppend += '				</div>'
											+ '				<div class="col-xs-2 col-sm-2 col-md-2 noPadding">'
							if(val.promotions[1].options[0].value != '') {
								strToAppend += '<div class="imageHappyHours hoverShadow">'
											+ '						<img src="/web/img/pictoHappyHours.png" alt="">'
											+ '					</div>';
							}
							strToAppend += '				</div>'
											+ '				<div class="col-xs-2 col-sm-2 col-md-3 noPadding">';
							if(val.comments.length > 0) {
								var tot = 0;
								$.each(val.comments, function (ke, va) {
									tot += va.note;
								});
								var average = tot/(val.comments.length);
								strToAppend += '				<p class="shadowNote">' + average + '/10</p>'
											+ '					<p class="shadowNbAvis hoverShadow">' + val.comments.length + ' avis</p>';
							}
							strToAppend += '				</div>'
											+ '				<div class="shadowAdresse col-xs-12 col-sm-12 col-md-12 noPadding hoverShadow">'
											+ '					<p>' + val.adress + ', ' + val.zipcode + ' ' + val.town + '</p>'
											+ '				</div>'
											+ '			</div>'
											+ '	</div>'
											+ '</div>'
											+ '</a>';
                        });
						
						$noSearchList.addClass('hidden');
						$resultBody.removeClass('hidden');
                        $resultBody.empty().append(strToAppend);

                        if (data == '')
                            $resultBody.append('<div class="singleResult">Aucun résultat pour "' + search + '"</div>');
                    }
                });
            } else if(search.length == 0) {
            	$noSearchList.removeClass('hidden');
            	$resultBody.addClass('hidden');
                $resultBody.empty().addClass('noSearch');
            }
        }, 400);  
    });
	$(document).ready(function() {
		var search = window.location.search.replace("?search=", "");
		$searchInput = $("#barsSearchInput");
		$searchInput.val(search);
		$searchInput.keyup();
	});
	</script>
{% endblock %}
